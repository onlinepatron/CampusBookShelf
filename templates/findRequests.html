{% extends "base.html" %}

{% block title %}Find Requests{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Find Book Requests</h2>
  
  <form id="searchForm" class="mb-3">
    <div class="form-group">
      <label for="genre">Genre:</label>
      <input type="text" class="form-control" id="genre" name="genre">
    </div>
    <div class="form-group">
      <label for="title">Title:</label>
      <input type="text" class="form-control" id="title" name="title">
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
  </form>

  <div class="table-responsive">
    <table id="resultsTable" class="table mt-4">
      <thead class="thead-dark">
        <tr>
          <th>Title</th>
          <th>Author</th>
          <th>Genre</th>
          <th>Message</th>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody>
        <!-- Search results will be inserted here -->
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
  function loadRequests(formData = '') {
    $.ajax({
      url: '/api/findRequests',
      type: 'GET',
      data: formData,
      success: function(response) {
        console.log('Data received:', response);
        const resultsBody = $('#resultsTable tbody');
        resultsBody.empty();
        if (response && response.length) {
          response.forEach(function(request) {
            const row = `
              <tr>
                <td>${request.title}</td>
                <td>${request.author}</td>
                <td>${request.genre}</td>
                <td>${request.message}</td>
                <td>
                  <div class="comments">
                    <h6>Comments:</h6>
                    ${request.comments.map(comment => `<p>${comment.user_id}: ${comment.text}</p>`).join('')}
                  </div>
                  <div class="comment-box">
                    <form action="/book/${request.id}/comment" method="post">
                      <textarea name="text" required></textarea>
                      <button type="submit" class="btn btn-primary">Add Comment</button>
                    </form>
                  </div>
                </td>
              </tr>
            `;
            resultsBody.append(row);
          });
        } else {
          resultsBody.append('<tr><td colspan="5">No requests found.</td></tr>');
        }
      },
      error: function() {
        const resultsBody = $('#resultsTable tbody');
        resultsBody.append('<tr><td colspan="5">Error fetching data. Please try again.</td></tr>');
      }
    });
  }

  // Load all requests initially
  loadRequests();

  $('#searchForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    loadRequests(formData);
  });
});
</script>
{% endblock %}