{% extends "base.html" %}

{% block title %}Find Requests{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Find Book Requests</h2>
  
  <form id="searchForm" class="mb-3">
    <div class="form-group">
      <label for="title">Book Title:</label>
      <input type="text" class="form-control" id="title" name="title">
    </div>
    <div class="form-group">
      <label for="genre">Genre:</label>
      <input type="text" class="form-control" id="genre" name="genre">
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
  </form>

  <div class="table-responsive">
    <table id="resultsTable" class="table mt-4">
      <thead class="thead-dark">
        <tr>
          <th>Title</th>
          <th>Author</th>
          <th>Genre</th>
          <th>Synopsis</th>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody>
        {% for book in books %}
        <tr>
          <td>{{ book.title }}</td>
          <td>{{ book.author }}</td>
          <td>{{ book.genre }}</td>
          <td>{{ book.synopsis }}</td>
          <td>
            <div class="comments">
              <h6>Comments:</h6>
              {% for comment in book.comments %}
              <p>{{ comment.user.username }}: {{ comment.text }}</p>
              {% endfor %}
            </div>
            <div class="comment-box">
              <form action="{{ url_for('book.add_book_comment', book_id=book.id) }}" method="post">
                <textarea name="text" required></textarea>
                <button type="submit" class="btn btn-primary">Add Comment</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
  function loadBooks(formData = '') {
    $.ajax({
      url: '/api/findRequests',
      type: 'GET',
      data: formData,
      success: function(response) {
        console.log('Data received:', response);
        const resultsBody = $('#resultsTable tbody');
        resultsBody.empty();
        if (response && response.length) {
          response.forEach(function(book) {
            const row = \`
              <tr>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.genre}</td>
                <td>${book.synopsis}</td>
                <td>
                  <div class="comments">
                    <h6>Comments:</h6>
                    ${book.comments.map(comment => \`<p>${comment.user}: ${comment.text}</p>\`).join('')}
                  </div>
                  <div class="comment-box">
                    <form action="/book/${book.id}/comment" method="post">
                      <textarea name="text" required></textarea>
                      <button type="submit" class="btn btn-primary">Add Comment</button>
                    </form>
                  </div>
                </td>
              </tr>
            \`;
            resultsBody.append(row);
          });
        } else {
          resultsBody.append('<tr><td colspan="5">No books found.</td></tr>');
        }
      },
      error: function() {
        const resultsBody = $('#resultsTable tbody');
        resultsBody.append('<tr><td colspan="5">Error fetching data. Please try again.</td></tr>');
      }
    });
  }

  $('#searchForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    loadBooks(formData);
  });
});
</script>
{% endblock %}